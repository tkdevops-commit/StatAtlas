<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>World Map Color Highlighter</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <style>
    body {
      margin: 0;
      background: #fff;
      color: #111;
      font-family: sans-serif;
    }

    nav {
      background-color: #222;
      color: white;
      display: flex;
      justify-content: space-between;
      padding: 10px 20px;
      align-items: center;
      font-size: 18px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
      height: 60px;
      box-sizing: border-box;
    }

    .logo {
      font-weight: bold;
    }

    .tools {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background-color: #444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #555;
    }

    #map-container {
      position: relative; /* needed for overlay positioning */
      width: 100vw;
      height: calc(100vh - 60px);
      overflow: hidden;
    }

    svg {
      position: absolute; /* sit under notes overlay */
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    #autocomplete-list li {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      background: #fff;
      color: #111;
    }

    #autocomplete-list li:hover {
      background-color: #f0f0f0;
    }

    .chat-box {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 12px;
    }

    #chat-input {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      width: 200px;
    }

    #chat-send {
      background: #3498db;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    #chat-send:hover {
      background: #2980b9;
    }

    /* Notes overlay sits above the SVG, but allows dragging */
    #notes-overlay {
      position: absolute;
      inset: 0;             /* top:0; right:0; bottom:0; left:0 */
      z-index: 5;
      pointer-events: none; /* so map stays interactive below */
    }

    .note {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: move;
      position: absolute;
      font-size: 14px;
      max-width: 260px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      pointer-events: auto; /* enable dragging on the note itself */
      user-select: none;
    }

    .note .close {
      position: absolute;
      top: 4px;
      right: 6px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">World Map Illustrator</div>
    <div class="tools">
      <input type="color" id="colorPicker" value="#ff0000" />
      <button id="refresh-map">Refresh Map</button>
      <div style="position: relative;">
        <input type="text" id="country-search" placeholder="Search country..." autocomplete="off" />
        <ul id="autocomplete-list" style="position:absolute; top:100%; left:0; right:0; background:white; list-style:none; margin:0; padding:0; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:1000;"></ul>
      </div>

      <!-- Chat Box -->
      <div class="chat-box">
        <input type="text" id="chat-input" placeholder="Add a fact…" />
        <button id="chat-send">Add</button>
      </div>

      <button id="download-svg">Download SVG</button>
    </div>
  </nav>

  <div id="map-container">
    <!-- SVG is appended here by D3 -->
    <!-- Notes overlay sits above the SVG -->
    <div id="notes-overlay"></div>
  </div>

  <script>
    const width = 1000;
    const height = 600;

    // Build SVG map
    const svg = d3.select("#map-container")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    const mapGroup = svg.append("g");

    const projection = d3.geoNaturalEarth1()
      .scale(160)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    const colorPicker = document.getElementById("colorPicker");
    let selectedColor = colorPicker.value;

    colorPicker.addEventListener("input", () => {
      selectedColor = colorPicker.value;
    });

    const tooltip = d3.select("body")
      .append("div")
      .attr("id", "tooltip")
      .style("position", "absolute")
      .style("padding", "6px 10px")
      .style("background", "#222")
      .style("color", "#fff")
      .style("border-radius", "4px")
      .style("pointer-events", "none")
      .style("font-size", "14px")
      .style("display", "none");

    let hoverTimeout;

    const countryInput = document.getElementById("country-search");
    const autocompleteList = document.getElementById("autocomplete-list");
    const countryPaths = {};
    const countryNames = [];

    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json").then(worldData => {
      const countries = topojson.feature(worldData, worldData.objects.countries).features;

      mapGroup.selectAll("path")
        .data(countries)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", "#2c3e50")
        .attr("stroke", "#ffffff")
        .attr("stroke-width", 0.5)
        .attr("data-name", d => d.properties.name || "")
        .each(function (d) {
          const name = d.properties.name?.trim();
          if (name) {
            const key = name.toLowerCase();
            countryPaths[key] = this;
            countryNames.push(name);
          }
        })
        .on("click", function () {
          d3.select(this).attr("fill", selectedColor);
        })
        .on("mouseover", function (event, d) {
          const name = d.properties.name || "";
          hoverTimeout = setTimeout(() => {
            tooltip
              .style("left", ${event.pageX + 10}px)
              .style("top", ${event.pageY + 10}px)
              .style("display", "block")
              .html(name);
          }, 2000); // Show after 2 seconds
        })
        .on("mousemove", function (event) {
          tooltip
            .style("left", ${event.pageX + 10}px)
            .style("top", ${event.pageY + 10}px);
        })
        .on("mouseout", function () {
          clearTimeout(hoverTimeout);
          tooltip.style("display", "none");
        });

      // Autocomplete logic
      countryInput.addEventListener("input", function () {
        const query = this.value.toLowerCase();
        autocompleteList.innerHTML = "";
        if (!query) return;

        const filtered = countryNames.filter(name =>
          name.toLowerCase().includes(query)
        );

        filtered.forEach(name => {
          const item = document.createElement("li");
          item.textContent = name;
          item.addEventListener("click", () => {
            countryInput.value = name;
            autocompleteList.innerHTML = "";
            const key = name.toLowerCase();
            if (countryPaths[key]) {
              d3.select(countryPaths[key]).attr("fill", selectedColor);
            }
          });
          autocompleteList.appendChild(item);
        });
      });

      // On Enter key
      countryInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          const name = countryInput.value.trim().toLowerCase();
          autocompleteList.innerHTML = "";
          if (countryPaths[name]) {
            d3.select(countryPaths[name]).attr("fill", selectedColor);
          }
        }
      });

      // Close suggestions when clicking outside
      document.addEventListener("click", (e) => {
        if (!countryInput.contains(e.target) && !autocompleteList.contains(e.target)) {
          autocompleteList.innerHTML = "";
        }
      });
    });

    // Zoom behavior
    const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on("zoom", (event) => {
        mapGroup.attr("transform", event.transform);
      });

    svg.call(zoom);

    // Refresh Button (no reload)
    document.getElementById("refresh-map").addEventListener("click", () => {
      d3.selectAll("path").attr("fill", "#2c3e50");
      countryInput.value = "";
      autocompleteList.innerHTML = "";
      d3.select("#tooltip").style("display", "none");
      svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
    });

    // Download the rendered SVG
    document.getElementById("download-svg").addEventListener("click", () => {
      const svgNode = document.querySelector("#map-container svg"); // ensure correct SVG
      const clone = svgNode.cloneNode(true);
      clone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      const svgData = new XMLSerializer().serializeToString(clone);
      const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const downloadLink = document.createElement("a");
      downloadLink.href = url;
      downloadLink.download = "highlighted-world-map.svg";
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    });

    /* =========================
       Movable Notes (“chat”)
       ========================= */

    const notesOverlay = document.getElementById("notes-overlay");

    // Track last mouse position over the map container
    let lastMouse = { x: 120, y: 120 };
    document.getElementById("map-container").addEventListener("mousemove", (e) => {
      const rect = e.currentTarget.getBoundingClientRect();
      lastMouse.x = e.clientX - rect.left;
      lastMouse.y = e.clientY - rect.top;
    });

    // Single handler: create a draggable note at last mouse position
    document.getElementById("chat-send").addEventListener("click", () => {
      const input = document.getElementById("chat-input");
      const message = input.value.trim();
      if (!message) return;

      createNote(message, lastMouse.x, lastMouse.y);
      input.value = "";
    });

    document.getElementById("chat-input").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        document.getElementById("chat-send").click();
      }
    });

    function createNote(text, x, y) {
      const note = document.createElement("div");
      note.className = "note";
      note.style.left = x + "px";
      note.style.top = y + "px";
      note.innerHTML = 
        <span class="close" title="Delete">×</span>
        <div class="content" contenteditable="true"></div>
      ;
      note.querySelector(".content").textContent = text;

      notesOverlay.appendChild(note);
      makeDraggable(note);

      // delete button
      note.querySelector(".close").addEventListener("click", () => {
        notesOverlay.removeChild(note);
      });
    }

    function makeDraggable(element) {
      let offsetX = 0, offsetY = 0, isDown = false;

      element.addEventListener("mousedown", (e) => {
        if ((e.target).classList.contains("close")) return; // allow delete without drag
        isDown = true;
        element.style.zIndex = 1000; // top while dragging
        const rect = element.getBoundingClientRect();
        const parentRect = notesOverlay.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;

        // Move with mouse
        const onMove = (ev) => {
          if (!isDown) return;
          let left = ev.clientX - parentRect.left - offsetX;
          let top  = ev.clientY - parentRect.top  - offsetY;

          // clamp inside overlay
          left = Math.max(0, Math.min(left, parentRect.width - rect.width));
          top  = Math.max(0, Math.min(top,  parentRect.height - rect.height));

          element.style.left = left + "px";
          element.style.top  = top  + "px";
        };

        const onUp = () => {
          isDown = false;
          element.style.zIndex = 10;
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        };

        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });
    }
  </script>
</body>
</html>
