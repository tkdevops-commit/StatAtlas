<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>World Intelligence Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      overflow: hidden;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #222;
      padding: 10px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    h1 {
      font-size: 18px;
      color: #0ff;
      letter-spacing: 0.5px;
    }
    #toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    button {
      background: #333;
      color: #eee;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #444;
    }
    input[type="color"], input[type="text"] {
      background: #222;
      color: #eee;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px;
    }
    #map-container {
      position: relative;
      width: 100vw;
      height: calc(100vh - 60px);
    }
    svg {
      width: 100%;
      height: 100%;
      background: #181818;
      cursor: grab;
    }
    svg:active {
      cursor: grabbing;
    }
    #tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 13px;
    }
    #autocomplete {
      position: absolute;
      background: #222;
      border: 1px solid #333;
      list-style: none;
      margin: 0;
      padding: 0;
      width: 180px;
      max-height: 150px;
      overflow-y: auto;
      display: none;
      z-index: 10;
    }
    #autocomplete li {
      padding: 6px 10px;
      cursor: pointer;
    }
    #autocomplete li:hover {
      background: #333;
    }
    #notes-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }
    .note {
      position: absolute;
      background: #202020;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 10px;
      width: 160px;
      color: #eee;
      pointer-events: all;
      cursor: grab;
    }
    .note .close {
      float: right;
      cursor: pointer;
      color: #888;
      font-weight: bold;
    }
    .note .content {
      margin-top: 4px;
      outline: none;
    }
  </style>
</head>
<body>

<header>
  <h1>World Intelligence Map</h1>
  <div id="toolbar">
    <input type="color" id="color-picker" value="#00ffff" title="Choose country color" />
    <input type="text" id="search" placeholder="Search country..." />
    <ul id="autocomplete"></ul>
    <button id="add-note">Add Note</button>
    <button id="reset-zoom">Reset Zoom</button>
    <button id="download-map">Download SVG</button>
  </div>
</header>

<div id="map-container">
  <svg id="world-map"></svg>
  <div id="tooltip"></div>
  <div id="notes-overlay"></div>
</div>

<script>
// === Data & Initial Setup ===
const svg = d3.select("#world-map");
const tooltip = d3.select("#tooltip");
const overlay = document.getElementById("notes-overlay");

const projection = d3.geoNaturalEarth1().scale(200).translate([480, 300]);
const path = d3.geoPath(projection);
let selectedColor = document.getElementById("color-picker").value;
let hoverTimeout;

// === Load and Render Map ===
d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(data => {
  const countries = topojson.feature(data, data.objects.countries).features;

  svg.append("g")
    .selectAll("path")
    .data(countries)
    .join("path")
    .attr("d", path)
    .attr("fill", "#2a2a2a")
    .attr("stroke", "#555")
    .attr("stroke-width", 0.5)
    .on("mouseover", (event, d) => {
      hoverTimeout = setTimeout(() => {
        tooltip.style("opacity", 1)
               .text(d.properties.name)
               .style("left", event.pageX + 8 + "px")
               .style("top", event.pageY - 28 + "px");
      }, 800);
    })
    .on("mouseout", () => {
      clearTimeout(hoverTimeout);
      tooltip.style("opacity", 0);
    })
    .on("click", function() {
      d3.select(this)
        .transition()
        .duration(300)
        .attr("fill", selectedColor);
    });

  initZoom();
});

// === Zoom ===
function initZoom() {
  const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", (event) => {
      svg.selectAll("path").attr("transform", event.transform);
    });
  svg.call(zoom);
  document.getElementById("reset-zoom").addEventListener("click", () => {
    svg.transition().duration(600).call(zoom.transform, d3.zoomIdentity);
  });
}

// === Color Picker ===
document.getElementById("color-picker").addEventListener("input", e => {
  selectedColor = e.target.value;
});

// === Notes ===
document.getElementById("add-note").addEventListener("click", () => {
  createNote("Type here...");
});

function createNote(text) {
  const note = document.createElement("div");
  note.className = "note";
  note.style.left = "40px";
  note.style.top = "60px";

  const close = document.createElement("span");
  close.className = "close";
  close.textContent = "Ã—";
  close.title = "Delete note";
  close.onclick = () => note.remove();

  const content = document.createElement("div");
  content.className = "content";
  content.contentEditable = true;
  content.textContent = text;

  note.append(close, content);
  overlay.appendChild(note);

  // Dragging logic
  let offsetX, offsetY, isDragging = false;
  note.addEventListener("mousedown", e => {
    isDragging = true;
    offsetX = e.offsetX;
    offsetY = e.offsetY;
    note.style.cursor = "grabbing";
  });
  document.addEventListener("mousemove", e => {
    if (!isDragging) return;
    note.style.left = e.pageX - offsetX + "px";
    note.style.top = e.pageY - offsetY + "px";
  });
  document.addEventListener("mouseup", () => {
    isDragging = false;
    note.style.cursor = "grab";
  });
}

// === Download SVG ===
document.getElementById("download-map").addEventListener("click", () => {
  const serializer = new XMLSerializer();
  let source = serializer.serializeToString(svg.node());
  if (!source.match(/^<svg[^>]+xmlns=/)) {
    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
  }
  const blob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "world-intel-map.svg";
  a.click();
  URL.revokeObjectURL(url);
});

// === Autocomplete (lightweight) ===
const countriesList = ["Australia","Canada","China","France","Germany","India","Japan","Russia","United States","United Kingdom"];
const input = document.getElementById("search");
const list = document.getElementById("autocomplete");

input.addEventListener("input", e => {
  const val = e.target.value.toLowerCase();
  list.innerHTML = "";
  if (!val) return list.style.display = "none";

  const filtered = countriesList.filter(c => c.toLowerCase().includes(val));
  if (filtered.length === 0) return list.style.display = "none";

  const fragment = document.createDocumentFragment();
  filtered.forEach(name => {
    const item = document.createElement("li");
    item.textContent = name;
    item.addEventListener("click", () => {
      input.value = name;
      list.style.display = "none";
    });
    fragment.appendChild(item);
  });
  list.appendChild(fragment);
  list.style.display = "block";
});
</script>

</body>
</html>
